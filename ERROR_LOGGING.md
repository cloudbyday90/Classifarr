# Error Logging System

Classifarr includes a comprehensive error logging and export system that helps developers and users track, diagnose, and report issues effectively.

## Features

### ðŸ” Comprehensive Error Tracking
- **Unique Error IDs**: Every error gets a UUID for easy reference
- **Context Capture**: Automatic capture of request context, system info, and metadata
- **Privacy-First**: Sensitive data (passwords, tokens, API keys) is automatically redacted
- **Stack Traces**: Full stack traces preserved for debugging

### ðŸ“Š Statistics Dashboard
- Real-time error statistics
- Errors by module breakdown
- 24-hour and 7-day trend tracking
- Resolution tracking

### ðŸ› AI-Friendly Bug Reports
- One-click markdown bug report generation
- Optimized format for GitHub issues
- Includes all relevant context for AI analysis
- Copy to clipboard functionality

### ðŸ’¾ Export & Management
- Export logs as JSON for analysis
- Filter by level, module, date range
- Mark errors as resolved
- Automated log retention and cleanup

## API Endpoints

### List Logs
```http
GET /api/logs?level=ERROR&module=TestModule&limit=50&offset=0
```

Returns a paginated list of error logs with optional filtering.

**Query Parameters:**
- `level` (optional): Filter by log level (ERROR, WARN, INFO, DEBUG)
- `module` (optional): Filter by module name
- `limit` (optional, default: 100): Number of results per page
- `offset` (optional, default: 0): Pagination offset

**Response:**
```json
{
  "logs": [
    {
      "id": 1,
      "error_id": "550e8400-e29b-41d4-a716-446655440000",
      "level": "ERROR",
      "module": "ClassificationService",
      "message": "Failed to classify media",
      "stack_trace": "Error: ...",
      "request_context": {...},
      "system_context": {...},
      "metadata": {...},
      "resolved": false,
      "created_at": "2025-12-19T20:00:00.000Z"
    }
  ],
  "total": 150,
  "limit": 50,
  "offset": 0
}
```

### Get Single Error
```http
GET /api/logs/error/:errorId
```

Retrieve detailed information about a specific error by its UUID.

### Generate Bug Report
```http
GET /api/logs/error/:errorId/report
```

Generate a markdown-formatted bug report suitable for GitHub issues.

**Query Parameters:**
- `format` (optional): Set to `json` to get JSON response instead of markdown

**Response (markdown):**
```markdown
## ðŸ› Bug Report: 550e8400-e29b-41d4-a716-446655440000

**Generated:** 2025-12-19T20:30:00.000Z
**Error Time:** 2025-12-19T20:00:00.000Z
**Module:** `ClassificationService`
**Level:** ERROR

### Error Message
```
Failed to classify media
```

### Stack Trace
```
Error: Failed to classify media
    at ClassificationService.classify (/app/src/services/classification.js:45:11)
    ...
```

### Request Context
- **URL:** `POST /api/classification/classify`
- **IP:** 192.168.1.100
- **User Agent:** Mozilla/5.0...

### System Information
- **App Version:** 1.0.0
- **Node Version:** v20.11.0
- **Platform:** linux (x64)
- **Uptime:** 5 hours
- **Memory:** 128MB / 256MB

---
*This report was auto-generated by Classifarr. Error ID: `550e8400-e29b-41d4-a716-446655440000`*
```

### Export Logs
```http
GET /api/logs/export?from=2025-12-01&to=2025-12-31&level=ERROR&limit=1000
```

Export logs as JSON for analysis. Returns a downloadable JSON file.

### Get Statistics
```http
GET /api/logs/stats
```

Get error statistics and trends.

**Response:**
```json
{
  "summary": {
    "total_errors": 150,
    "error_count": 120,
    "warn_count": 30,
    "resolved_count": 100,
    "last_24h": 5,
    "last_7d": 45
  },
  "byModule": [
    { "module": "ClassificationService", "count": 50 },
    { "module": "TMDBService", "count": 30 }
  ],
  "recentErrors": [
    {
      "error_id": "...",
      "module": "...",
      "message": "...",
      "created_at": "..."
    }
  ]
}
```

### Mark Error as Resolved
```http
POST /api/logs/error/:errorId/resolve
Content-Type: application/json

{
  "notes": "Fixed in version 1.0.1"
}
```

### Clean Up Old Logs
```http
POST /api/logs/cleanup
```

Clean up old logs based on retention settings. Requires admin privileges.

## Using the Logger in Code

### Basic Usage

```javascript
const { createLogger } = require('./utils/logger');
const logger = createLogger('MyModule');

// Log an error with database persistence
const errorId = await logger.error('Something went wrong', {
  userId: 123,
  action: 'processRequest'
});

console.log(`Error logged with ID: ${errorId}`);

// Log a warning
await logger.warn('Deprecation warning', {
  feature: 'oldAPI',
  replacement: 'newAPI'
});

// Log info (not persisted to database)
logger.info('Request processed successfully');

// Log debug info (not persisted to database)
logger.debug('Detailed debug information', { data: {...} });
```

### Error Handler Middleware

The error handler middleware automatically captures all unhandled errors in Express routes:

```javascript
// Routes will automatically log errors
app.get('/api/something', async (req, res) => {
  // If this throws, it will be caught and logged
  throw new Error('Something went wrong');
});

// Error response will include the error ID
{
  "error": "Something went wrong",
  "errorId": "550e8400-e29b-41d4-a716-446655440000",
  "timestamp": "2025-12-19T20:00:00.000Z"
}
```

### Logging with Request Context

```javascript
const errorId = await logger.error('Database connection failed', {
  query: 'SELECT * FROM users',
  errorCode: 'ECONNREFUSED'
}, {
  req,  // Express request object
  stack: err.stack,
  metadata: {
    retryCount: 3,
    timeout: 5000
  }
});
```

## Frontend Usage

### Accessing the Logs Page

1. Navigate to **Settings** in the sidebar
2. Click the **Logs** tab
3. View, filter, and manage error logs

### Filtering Logs

- **Level**: Filter by ERROR, WARN, INFO, or DEBUG
- **Module**: Search by module name
- **Per Page**: Adjust pagination size

### Viewing Error Details

1. Click **Details** on any error row
2. View full error information including:
   - Error message and stack trace
   - Request context
   - System information
   - Additional metadata

### Generating Bug Reports

1. Open error details
2. Click **ðŸ“‹ Copy Bug Report**
3. Paste into a GitHub issue

### Exporting Logs

1. Set your filters
2. Click **Export Logs**
3. Download JSON file for analysis

## Database Schema

### error_log Table

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL | Primary key |
| error_id | UUID | Unique identifier for the error |
| level | VARCHAR(10) | Error level (ERROR, WARN, INFO, DEBUG) |
| module | VARCHAR(100) | Module that logged the error |
| message | TEXT | Error message |
| stack_trace | TEXT | Stack trace (if available) |
| request_context | JSONB | Request information |
| system_context | JSONB | System information |
| metadata | JSONB | Additional context |
| resolved | BOOLEAN | Whether error is resolved |
| resolved_at | TIMESTAMP | When error was resolved |
| resolution_notes | TEXT | Notes about resolution |
| created_at | TIMESTAMP | When error occurred |

### app_log Table

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL | Primary key |
| level | VARCHAR(10) | Log level |
| module | VARCHAR(100) | Module name |
| message | TEXT | Log message |
| metadata | JSONB | Additional data |
| created_at | TIMESTAMP | When logged |

## Configuration

### Log Retention

Configure log retention in the settings table:

```sql
UPDATE settings SET value = '90' WHERE key = 'error_log_retention_days';
UPDATE settings SET value = '30' WHERE key = 'log_retention_days';
```

### Log Level

Set the log level via environment variable:

```bash
LOG_LEVEL=DEBUG  # DEBUG, INFO, WARN, ERROR
```

## Best Practices

### When to Use Each Log Level

- **ERROR**: Use for exceptions and failures that need attention
  - Database connection failures
  - API request failures
  - Classification failures
  
- **WARN**: Use for unexpected conditions that don't prevent operation
  - Deprecation warnings
  - Configuration issues
  - Retryable failures

- **INFO**: Use for normal operational messages
  - Request processing
  - Successful operations
  - Status updates

- **DEBUG**: Use for detailed diagnostic information
  - Variable values
  - Flow control
  - Detailed request/response data

### Error Logging Best Practices

1. **Always capture context**: Include relevant IDs, parameters, and state
2. **Don't log sensitive data**: Passwords, tokens, and API keys are automatically redacted
3. **Use descriptive messages**: Include what failed and why
4. **Include error IDs in user-facing messages**: Users can reference them in support requests
5. **Mark errors as resolved**: Keep the log clean and track what's been fixed

## Troubleshooting

### Error logs not appearing

1. Check database connection
2. Verify migration `004_enhanced_logging.sql` has been applied
3. Check log level configuration

### Export not working

1. Check browser console for errors
2. Verify API endpoint is accessible
3. Check file permissions (for local development)

### Performance concerns

1. Use log retention to clean up old logs regularly
2. Consider archiving old resolved errors
3. Use pagination when viewing large log sets

## Migration Guide

To apply the error logging migration to an existing database:

```bash
# Using psql
psql -U classifarr_user -d classifarr_db < database/migrations/004_enhanced_logging.sql

# Using Docker
docker exec -i classifarr_db psql -U classifarr_user -d classifarr_db < database/migrations/004_enhanced_logging.sql
```

## Contributing

When adding new features, use the logger to track errors and important events:

```javascript
const { createLogger } = require('./utils/logger');
const logger = createLogger('NewFeature');

try {
  // Your code here
} catch (error) {
  const errorId = await logger.error('Feature failed', {
    error: error.message
  }, {
    req,
    stack: error.stack,
    metadata: { featureId: 123 }
  });
  
  throw error; // Let error handler middleware handle the response
}
```
